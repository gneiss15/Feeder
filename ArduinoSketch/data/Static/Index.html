<!DOCTYPE html>
<html>
<!--
	Infos
local testing:
python3 -m http.server
http://localhost:8000
-->
<head>
<meta http-equiv="content-type" content="text/html;charset=UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="icon" type="image/png" href="/fish.png">
<!--
<script type="application/javascript" src="Index.js"></script>
-->
<!--	CSS	-->
<style>
 table.ct1{margin-left:auto;margin-right:auto;border-collapse:collapse;}
 #t1 table,#t1 th,#t1 td{padding:4px;text-align:center;border-collapse:collapse;}
 #t1 th{border:1px solid black;padding-top:10px;background-color:#04AA6D;color:white;}
 #t1 td{border:1px solid black;}
 #t1 tr:nth-child(even){background-color:#f2f2f2;}
 #t1b th{border:0px;padding-top:10px;padding-bottom:10px;background-color:white;}
 .tab{display:flex;justify-content:center;align-items:center;border:1px solid #ccc;background-color:#f1f1f1;overflow:hidden;}
 .tab button{background-color:inherit;float:left;border:none;outline:none;cursor:pointer;padding:14px 16px;transition:0.3s;font-size:17px;}
 .tab button:hover{background-color:#ddd;}
 .tab button.active{background-color:#ccc;}
 .tabcontent{display:none;padding:6px 12px;border:1px solid #ccc;border-top:none;}
 #t1b input { font-size:1.2em;font-weight:bold; }
 #ConfigTab input{margin:0;}
 table.ct2{margin-left:auto;margin-right:auto;text-align:center;border-collapse:collapse;border:1px solid black;}
 table.ct2 tr{border:1px solid black;}
 table.ct2 th{border:1px solid black;}
 table.ct3{margin-left:auto;margin-right:auto;text-align:center;border-collapse:collapse;border:1px solid black;font-size:1.5em;font-weight:bold;}
 table.ct3 tr{height:20px;}
 table.ct3 th{padding:20px;}
</style>
</head>
<body>
<!--	ResponceDiv	-->
<div id="ResDiv" style="display:none;text-align:center;">
</div>
<!--	MainDiv	-->
<div id="MainDiv">
<!--	Tabbed View	-->
<div class="tab">
 <button id="TabFeedTimes" class="tablinks" onclick="TabSelect(0)">FeedTimes</button>
 <button id="TabConfiguration" class="tablinks" onclick="TabSelect(1)">Configuration</button>
 <button id="TabUpdate" class="tablinks" onclick="TabSelect(2)">Fw-Update</button>
</div>
<!--	FeedTimes	-->
<div id="FeedTimes" class="tabcontent" display=block>
 <form method="post" enctype="application/x-www-form-urlencoded" action="/SetFeedTimes/" id="TimeTabForm">
  <table class="ct1" id="t1">
   <thead><caption><h1>FeedTimes</h1></caption>
    <tr id="b"><th>#</th><th>Active</th><th>Time</th><th>Sun</th><th>Mon</th><th>Tue</th><th>Wed</th><th>Thur</th><th>Fri</th><th>Sat</th><th>Portions</th></tr>
   <tfoot>
    <tr id="t1b">
     <th colspan=5><input type="submit" value="Save"></th>
     <th colspan=6><input type="reset" value="Reset"></th>
    </tr>
   <tbody id="TimeTab">
  </table>
 </form>
</div>
<!--	Configuration	-->
<div id="Configuration" class="tabcontent" display=none>
 <form method="post" enctype="application/x-www-form-urlencoded" action="/SetConfig/" id="ConfigTabForm">
  <table class="ct1" id="t2">
   <thead><caption><h1>Configuration</h1></caption>
   <tfoot>
    <tr id="t1b">
     <th><input type="submit" value="Save"></th>
     <th><input type="reset" value="Reset"></th>
    </tr>
   <tbody id="ConfigTab" style="text-align:left;">
  </table>
 </form>
</div>
<!--	Update	-->
<div id="Update" class="tabcontent" display=none>
 <form method='POST' enctype='multipart/form-data' action='/FwUpdate/'>
  <table class="ct3">
   <tr>
    <th colspan=2>Update Firmware</th>
   </tr>
   <tr>
    <th><input type='file' accept='.bin,.bin.signed,.bin.gz,.bin.gz.signed' name='firmware'></th>
    <th><input type='submit' value='Update'></th>
   </tr>
  </table>
 </form>
 <br>
 <form method='POST' enctype='multipart/form-data' action=/FwUpdate/>
  <table class="ct3">
   <tr>
    <th colspan=2>Update Filesystem</th>
   </tr>
   <tr>
    <th><input type='file' accept='.littlefs,.littlefs.signed,.littlefs.gz,.littlefs.gz.signed' name='filesystem'></th>
    <th><input type='submit' value='Update'></th>
   </tr>
  </table>
 </form>
</div>
</div>
</body>
<script>
//Select FeedTimes on load
document.addEventListener("loaded",TabRestore());
//Use own Submit
document.getElementById("TimeTabForm").addEventListener('submit',(event)=>{SubmitFeedTimes(event);});
document.getElementById("ConfigTabForm").addEventListener('submit',(event)=>{SubmitConfig(event);});
//Use own Reset
document.getElementById("TimeTabForm").addEventListener('reset',()=>{LoadFeedTimes();});
document.getElementById("ConfigTabForm").addEventListener('reset',()=>{LoadConfig();});

//ProcessResponce
var Func=-1;
function ProcessPostRes(htmlTxt){
  SetStatus(Func,parseInt(htmlTxt));}
//LoadJsonData
function LdJData(path,success){
  let xhr=new XMLHttpRequest();
  xhr.onload=function(){
    if(xhr.status===200){if(success)success(JSON.parse(xhr.responseText));}
     else{console.error(xhr);}};
  xhr.open("GET",path,true);
  xhr.send();}
//SendJsonData
function SendJData(form,jdata,func){
  Func=func;
  let xhr=new XMLHttpRequest();
  xhr.onload=function(){
    if(xhr.status===200)ProcessPostRes(xhr.responseText);
     else{console.error(xhr);}};
  xhr.open(form.method,form.action,true);
  xhr.setRequestHeader('Content-Type','application/json; charset=UTF-8');
  xhr.send(JSON.stringify(jdata));}
//change value of Cb
function ChChg( ele ){ele.value=ele.checked?1:0;}
//Make DOM Elements
function MkCb(name,val){return `<input type="checkbox" name="${name}" id="${name}" value=${val} ${val?"checked ":""}onclick="ChChg(this)">`;}
function MkTx(name,val,size=50){return `<input type=text name="${name}" id="${name}" size=${size}>`;}
function MkPw(name,val,size=50){return `<input type=password name="${name}" id="${name}" size=${size}>`;}
function MkNr(name,val){return `<input type=number name="${name}" id="${name}" min=0 max=15>`;}
function MkLbl(txt){return `<label for="${txt}">${txt}:&nbsp;&nbsp;</label>`;}
function MkSel(name,val){let r="";for(let i=1;i<=9;i++)r+=`<option${(val==i)?" selected":""}>${i}</option>`;return `<select name="${name}" id="${name}">${r}</select></td>`;}	
function MkTm(name,val){return `<input type="time" name="${name}" id="${name}" value="${val}">`;}
function MkCell(inner){return `<td>${inner}</td>`;}
function MkRow(inner,id='undefined'){return `<tr${id=="undefined"?"":" id=${id}"}>${inner}</td>`;}
//Get Value of DOM Elements
function GetVal(name){return document.querySelector(name).value;}
function GetIntVal(name){return parseInt(GetVal(name));}
function EleGetVal(ele){if(ele.matches('[type="checkbox"]')||ele.matches('[type="number"]'))return parseInt(ele.value);return ele.value;}
//Set Value of DOM Elements
function SetEle(ele,value){if(ele.matches('[type="checkbox"]')){let bit=parseInt(value);ele.value=bit;ele.checked=bit?true:false;}else ele.value=value;}
function GetCookie(cname){
  let name=cname+"=";
  let decodedCookie=decodeURIComponent(document.cookie);
  let ca=decodedCookie.split(';');
  for(let i=0;i<ca.length;i++){
    let c=ca[i];
    while(c.charAt(0)==' '){c=c.substring(1);}
    if(c.indexOf(name)==0)return c.substring(name.length,c.length);}
  return "";}
//*****************************
//Tabbed View
function TabSelect(nr){
  const nr2Name=["FeedTimes","Configuration","Update"];
  document.getElementById("ResDiv").style.display="none";
  document.getElementById("MainDiv").style.display="block";
  let tabcontent=document.getElementsByClassName("tabcontent");
  for(let i=0;i<tabcontent.length;++i)tabcontent[i].style.display="none";
  let tablinks=document.getElementsByClassName("tablinks");
  for(let i=0;i<tablinks.length;++i)tablinks[i].className=tablinks[i].className.replace(" active","");
  document.getElementById(nr2Name[nr]).style.display="block";
  document.getElementById("Tab"+nr2Name[nr]).className+=" active";
  document.cookie="TabNr="+nr+"; SameSite=Lax";}
function TabRestore(){
  let nr=GetCookie("TabNr");
  if(nr=="")nr="0";
  TabSelect(parseInt(nr));}
//*****************************
//FeedTimes(data)
function TimeRow(idx,row){
  let res=MkCell(idx)+MkCell(MkCb(`E${idx}_7`,(row[1]&(1<<7))?1:0))+MkCell(MkTm(`E${idx}_8`,row[0]));
  for(let i=0;i<7;++i)res+=MkCell(MkCb(`E${idx}_${i}`,(row[1]&(1<<i))?1:0));
  return MkRow(res+MkCell(MkSel(`E${idx}_9`,row[2])),`Z${idx}`);}
var NoOfFeedTimes=0;
function SetTimeData(data){
  NoOfFeedTimes=data.length;
  let res="";for(let r=0;r<NoOfFeedTimes;++r)res+=TimeRow(r,data[r]);
  document.getElementById("TimeTab").innerHTML=res;}
function LoadFeedTimes(){LdJData('FeedTimes.json',SetTimeData);}
//*****************************
//FeedTimes(submit)
function SubmitFeedTimes(event){
  event.preventDefault();
  let tab=document.getElementById("TimeTab");
  let jdata=[];
  for(let r=0;r<NoOfFeedTimes;++r){
    let bits=0;for(let b=0;b<8;++b)bits|=GetVal(`#E${r}_${b}`)<<b;
    jdata.push([GetVal(`#E${r}_8`),bits,GetIntVal(`#E${r}_9`)]);   }
  SendJData(event.target,jdata,0); }
//*****************************
//Configuration(Entries)
function CD(type,name){
  const type2Func={"c":MkCb,"t":MkTx,"p":MkPw,"n":MkNr};
  if(type=="d")return MkRow('<th style="padding-top:20px;"></th>');
  return MkRow(MkCell(MkLbl(name))+MkCell(type2Func[type](name)));}
function SetConfigEntries(data){
  let res='';for(var key in data)res+=CD(data[key],key); 
  document.getElementById("ConfigTab").innerHTML=res;
  LdJData('Config.json',SetConfigData);}
function LoadConfig(){LdJData('ConfigEntries.json',SetConfigEntries);}  
//*****************************
//Configuration(data)
function SetConfigData(data){for(var key in data)SetEle(document.getElementById(key),data[key]);}
//*****************************
//Configuration(submit)
function SubmitConfig(event){
  event.preventDefault();
  let es=document.getElementById("ConfigTab").querySelectorAll('input');
  let jdata={};for(let i=0;i<es.length;i++)jdata[es[i].id]=EleGetVal(es[i]);
  SendJData(event.target,jdata,1);}
//*****************************
//Start->Load Pages
LoadFeedTimes();
LoadConfig();

//*****************************
//ResDiv
function AddReloadButton(ResDiv){
  ResDiv.innerHTML+='<br>Reload by pressing::&nbsp;<button onclick=location="/Index.html">Reload</button>';}
function AddNotChanged(ResDiv){
  ResDiv.innerHTML+='<br>If You don`t have changed "WlanEnabled" and/or "ApEnabled" inside "Configuration", You may simply...';}
function AddReloadCountdown(ResDiv){
  ResDiv.innerHTML+='<br>Reloading in <span id="to">10</span> seconds, or<br><button onclick=location="/Index.html">Reload Now</button>';
  var t=10;var x = setInterval(function(){--t;document.getElementById("to").innerHTML=t;if(t<=0)location.replace("/Index.html")}, 1000);}
function FeedTimesNok(ResDiv){
  ResDiv.innerHTML+='<font color="red"><strong>Changing FeedTimes failed!</strong></font>';
  AddReloadCountdown(ResDiv);}
function FeedTimesOk(ResDiv){
  ResDiv.innerHTML+='FeedTimes changed';
  AddReloadCountdown(ResDiv);}
function ConfigNok(ResDiv){
  ResDiv.innerHTML+='<font color="red"><strong>Changing Config failed!</strong></font>';
  AddReloadCountdown(ResDiv);}
function ConfigOk(ResDiv){
  ResDiv.innerHTML+='Config changed, Rebooting...';
  AddNotChanged(ResDiv);
  AddReloadButton(ResDiv);}
function FwUpdateNok(ResDiv){
  ResDiv.innerHTML+='<font color="red"><strong>Firmware-Update failed!</strong></font>';
  AddReloadCountdown(ResDiv);}
function FwUpdateOk(ResDiv){
  ResDiv.innerHTML+='Firmware-Update successfully, Rebooting...';
  AddNotChanged(ResDiv);
  AddReloadButton(ResDiv);}
function SetStatus(func,ok){
  const funcTab = [ [ FeedTimesNok, FeedTimesOk ], [ ConfigNok, ConfigOk ], [ FwUpdateNok, FwUpdateOk ] ];
  document.getElementById("MainDiv").style.display="none";
  document.getElementById("ResDiv").style.display="block";
  let ResDiv=document.getElementById("ResDiv");
  ResDiv.innerHTML="";
  func = funcTab[ func ][ ok ];
  func(ResDiv);}
</script>
</html> 

